{% extends "main/base.html" %}
{% load static %}

{% block content %}
<h2>Аналитика по {{ org.name }}</h2>

<div class="row mb-3">
  <div class="col-md-6">
    <p>Общая сумма доходов: <b>{{ total_incomes }}</b> ₽</p>
    <p>Общая сумма расходов: <b>{{ total_expenses }}</b> ₽</p>
    <p>Баланс: <b>{{ balance }}</b> ₽</p>
  </div>
  <div class="col-md-6">
    <h5>Изменение текущего месяца (к предыдущему):</h5>
    <ul>
      <li>Расходы: 
        {% if exp_change_pct is not None %}
          <b>{{ exp_change_pct }} %</b>
        {% else %}
          <span class="text-muted">нет данных</span>
        {% endif %}
      </li>
      <li>Доходы: 
        {% if inc_change_pct is not None %}
          <b>{{ inc_change_pct }} %</b>
        {% else %}
          <span class="text-muted">нет данных</span>
        {% endif %}
      </li>
    </ul>
  </div>
</div>

<hr>

<div class="row mb-3">
  <div class="col-md-6">
    <h5>Прогноз (простой скользящий):</h5>
    <ul>
      <li>След. месяц расходы: <b>{{ forecast_exp }}</b> ₽</li>
      <li>След. месяц доходы: <b>{{ forecast_inc }}</b> ₽</li>
    </ul>
  </div>
</div>

<hr>

<div class="row mb-4">
  <div class="col-md-6">
    <h4>Месячные Расходы / Доходы / Баланс</h4>
    <canvas id="financesChart" width="400" height="200"></canvas>
  </div>
  <div class="col-md-6">
    <h4>Распределение расходов по категориям</h4>
    <canvas id="catChart" width="300" height="300"></canvas>
  </div>
</div>

<hr>

<div class="row">
  <div class="col-md-6">
    <h5>ТОП-5 доходных категорий</h5>
    {% if top_incomes_list %}
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Категория</th>
            <th>Сумма</th>
          </tr>
        </thead>
        <tbody>
        {% for row in top_incomes_list %}
          <tr>
            <td>{{ row.category }}</td>
            <td>{{ row.sum_inc }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">Нет доходов</p>
    {% endif %}
  </div>

  <div class="col-md-6">
    <h5>ТОП-5 поставщиков</h5>
    {% if top_suppliers_list %}
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Поставщик</th>
            <th>Сумма</th>
          </tr>
        </thead>
        <tbody>
        {% for row in top_suppliers_list %}
          <tr>
            <td>{{ row.supplier }}</td>
            <td>{{ row.sum_exp }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted">Нет расходов</p>
    {% endif %}
  </div>
</div>

<!-- JSON-данные для JS-графиков -->
<script type="application/json" id="monthLabelsJSON">
  {{ month_labels_json|safe }}
</script>
<script type="application/json" id="expensesListJSON">
  {{ expenses_list_json|safe }}
</script>
<script type="application/json" id="incomesListJSON">
  {{ incomes_list_json|safe }}
</script>
<script type="application/json" id="balanceListJSON">
  {{ balance_list_json|safe }}
</script>

<script type="application/json" id="catLabelsJSON">
  {{ cat_labels_json|safe }}
</script>
<script type="application/json" id="catValuesJSON">
  {{ cat_values_json|safe }}
</script>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<!-- Подключаем внешний файл analytics.js -->
<script src="{% static 'js/analytics.js' %}"></script>
{% endblock %}
